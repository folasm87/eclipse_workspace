package com.multivision.ehrms.action;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.log4j.Logger;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import com.multivision.ehrms.action.form.IssueForm;
import com.multivision.ehrms.business.Employee;
import com.multivision.ehrms.business.Issue;
import com.multivision.ehrms.business.Project;
import com.multivision.ehrms.exception.DataSourceConnectivityFailedException;
import com.multivision.ehrms.exception.DuplicateRecordException;
import com.multivision.ehrms.service.business.BusinessServiceFactory;
import com.multivision.ehrms.service.business.interfaces.IEmployeeBusinessService;
import com.multivision.ehrms.service.business.interfaces.IIssueBusinessService;
import com.multivision.ehrms.service.business.interfaces.IProjectBusinessService;

public class IssueAction extends BaseDispatchAction {
	
	private Logger logger = Logger.getRootLogger();
	BusinessServiceFactory bsFactory;

	public BusinessServiceFactory getBsFactory() {
		return bsFactory;
	}

	public void setBsFactory(BusinessServiceFactory bsFactory) {
		this.bsFactory = bsFactory;
	}

	@Override
	protected ActionForward perform(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		ActionForward forward = null;
		if (request.getParameter("method") != null) {
			String parameter = request.getParameter("method");
			if (parameter.equalsIgnoreCase("list")) {
				forward = list(mapping, form, request, response);
				logger.info("Forwarding List");
			} else if (parameter.equalsIgnoreCase("add")) {
				forward = add(mapping, form, request, response);
				logger.info("Forwarding Add");
			} else if (parameter.equalsIgnoreCase("save")) {
				forward = save(mapping, form, request, response);
				logger.info("Forwarding Save");
			} else if (parameter.equalsIgnoreCase("edit")) {
				forward = edit(mapping, form, request, response);
				logger.info("Forwarding Edit");
			} else if (parameter.equalsIgnoreCase("view")) {
				forward = view(mapping, form, request, response);
				logger.info("Forwarding View");
			}
		}
		logger.info("Forwarding...");
		return forward;
	}
	
	public ActionForward list(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		logger.info("Listing issue information");
		ActionForward forward = null;
		logger.info("Instantiated Action Forward");
		List<Issue> issues = getIssues();
		logger.info("Got ISSUES");
		request.setAttribute("ISSUES", issues);
		logger.info("Set ISSUES");
		forward = mapping.findForward("list");
		logger.info("Finished list function");
		
		return forward;
	}

	public ActionForward add(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		logger.info("Displaying add screen to add issue details");
		ActionForward forward = null;
		logger.info("1");
		IssueForm taskForm = (IssueForm) form;
		logger.info("2");
		taskForm.setAction("add");
		logger.info("3");
		clearFormValues(taskForm);
		logger.info("4");
		request.getSession(false).setAttribute("PROJECTS", fetchProjects());
		//request.getSession(false).setAttribute("EMPLOYEES", fetchEmployees());
		logger.info("5");
		forward = mapping.findForward("add");
		logger.info("6");
		return forward;
	}

	public ActionForward edit(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		logger.info("Displaying edit screen to edit issue details");
		ActionForward forward = null;
		logger.info("display1");
		IssueForm taskForm = (IssueForm) form;
		logger.info("display2");
		Long Id = null;
		logger.info("display3");
		if (request.getParameter("id") != null
				&& request.getParameter("id").length() > 0) {
			logger.info("display4");
			Id = Long.valueOf(request.getParameter("id"));
			logger.info("display5");
		}
		Issue issue = fetchIssue(Id);
		logger.info("display6");
		request.getSession(false).setAttribute("PROJECTS", fetchProjects());
		logger.info("display7");
		request.getSession(false).setAttribute("EMPLOYEES", fetchEmployees());
		logger.info("display8");
		taskForm.setAction("edit");
		logger.info("display9");
		setFormValues(taskForm, issue);
		logger.info("display10");
		forward = mapping.findForward("edit");
		logger.info("display11");
		return forward;
	}

	public ActionForward view(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		logger.info("Displaying view screen to display issue details");
		ActionForward forward = null;
		logger.info("view1");
		IssueForm taskForm = (IssueForm) form;
		logger.info("view2");
		Long Id = null;
		logger.info("view3");
		if (request.getParameter("id") != null
				&& request.getParameter("id").length() > 0) {
			logger.info("view4");
			Id = Long.valueOf(request.getParameter("id"));
			logger.info("view5");
		}
		logger.info("view6");
		Issue issue = fetchIssue(Id);
		logger.info("view7");
		setFormValues(taskForm, issue);
		logger.info("view8");
		forward = mapping.findForward("view");
		logger.info("view9");
		return forward;
	}

	public ActionForward save(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		logger.info("Trying to save the issue details");
		ActionForward forward = null;
		ActionMessages messages = new ActionMessages();
		forward = mapping.findForward("save");
		IssueForm taskForm = (IssueForm) form;
		try {
			saveValues(taskForm);
			messages.add("task_add_status", new ActionMessage(
					"issue.data.added.success"));
			saveMessages(request, messages);
			taskForm.setAction("save");
			logger.info("Saved the project details");
		} catch (DataSourceConnectivityFailedException dscfException) {
			logger.debug(dscfException);
			messages.add("task_add_status", new ActionMessage(
					"global.db.connectivity.failure"));
			saveMessages(request, messages);
		} catch (DuplicateRecordException drException) {
			logger.debug(drException);
			messages.add("task_add_status", new ActionMessage(
					"issue.data.added.duplicate.failed"));
			saveMessages(request, messages);
		} catch (Exception exception) {
			logger.debug(exception);
			messages.add("task_add_status",
					new ActionMessage("issue.data.added.general.failure",
							exception.getMessage()));
			saveMessages(request, messages);
		}
		return forward;
	}

	private List<Issue> getIssues() throws Exception {
		logger.info("Starting getIssues()");
		List<Issue> issues = new ArrayList<Issue>();
		logger.info("IIssueBusinessService");
		IIssueBusinessService projectService = (IIssueBusinessService) getBsFactory()
				.getFactory().getBean("taskBS");
		logger.info("getBSFactory IIssueBusinessService");
		issues = projectService.getIssues();
		logger.info("Got issues from IIssueBusinessService");
		return issues;
	}

	private void clearFormValues(IssueForm taskForm) {
		logger.info("a");
		taskForm.setName("");
		logger.info("b");
		taskForm.setEstimatedHours("");
		logger.info("c");
		taskForm.setIssueId(null);
		logger.info("d");
		taskForm.setProject(new Project());
		//taskForm.getProject().setId(1L);
		logger.info("e");
		taskForm.setIssueHandler(new Employee());
		//taskForm.getIssueHandler().setId(0L);
		logger.info("f");
		
	}

	private void setFormValues(IssueForm taskForm, Issue issue) {
		taskForm.setId(issue.getId());
		taskForm.setName(issue.getName());
		taskForm.setIssueId(issue.getIssueId());
		taskForm.setEstimatedHours(issue.getEstimatedHours());
		
		taskForm.setProject(issue.getProject());
		taskForm.getProject().setId(
				issue.getProject().getId());
		taskForm.getProject().setName(
				issue.getProject().getName());
		
		taskForm.setIssueHandler(issue.getIssueHandler());
		taskForm.getIssueHandler().setId(issue.getIssueHandler().getId());
		taskForm.getIssueHandler().setName(issue.getIssueHandler().getName());
	}

	private void saveValues(IssueForm taskForm) throws Exception {
		Issue issue = saveFormValues(taskForm);
		logger.info("11");
		IIssueBusinessService taskService = (IIssueBusinessService) getBsFactory()
				.getFactory().getBean("taskBS");
		logger.info("12");
		taskService.saveIssue(issue);
	}

	private Issue saveFormValues(IssueForm taskForm) throws Exception {
		Issue issue = new Issue();
		logger.info("13");
		if (!taskForm.getAction().equalsIgnoreCase("add")) {
			issue.setId(taskForm.getId());
		}
		logger.info("14");
		issue.setIssueId(taskForm.getIssueId());
		logger.info("15");
		issue.setName(taskForm.getName());
		logger.info("16");
		issue.setEstimatedHours(taskForm.getEstimatedHours());
		logger.info("17");
		issue.setProject(taskForm.getProject());
		/*issue.getProject().setId(
				taskForm.getProject().getId());*/
		logger.info("18");
		issue.getProject().setId(
				taskForm.getProject().getId());
		logger.info("19a");
		issue.getProject().setName(
				taskForm.getProject().getName());
		logger.info("19b");
		issue.setIssueHandler(taskForm.getIssueHandler());
		logger.info("19c");
		issue.getIssueHandler().setId(taskForm.getIssueHandler().getId());
		logger.info("20");
		issue.getIssueHandler().setName(taskForm.getIssueHandler().getName());
		logger.info("21");
		return issue;
	}

	private List<Project> fetchProjects() throws Exception {
		List<Project> projects = new ArrayList<Project>();
		IProjectBusinessService projectService = (IProjectBusinessService) getBsFactory()
				.getFactory().getBean("projectBS");
		projects = projectService.getProjects();
		return projects;
	}
	
	private List<Employee> fetchEmployees() throws Exception {
		List<Employee> employees = new ArrayList<Employee>();
		IEmployeeBusinessService employeeService = (IEmployeeBusinessService) getBsFactory()
				.getFactory().getBean("employeeBS");
		employees = employeeService.getEmployees();
		return employees;
	}

	private Issue fetchIssue(Long Id) throws Exception {
		Issue issue = null;
		IIssueBusinessService taskService = (IIssueBusinessService) getBsFactory()
				.getFactory().getBean("taskBS");
		issue = taskService.getIssue(Id);
		return issue;
	}

}
